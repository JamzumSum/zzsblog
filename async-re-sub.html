<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>re.sub如何异步替换？ - 鸽园</title><meta name="description" content="这是解析Qzone3TG系列的第二篇。代码见 aioqzone-feed/api/emoji.py 现在有这样一个需求： 这是一段[em]e100[/em]富文本[em]e101[/em]，是emotion_cgi_msgdetail_v6的返回[em]102[/em] 把上面这段文本里的表情码换成正常人能看的文字或 emoji。大家一眼就能看出来，得用正则表达式。 这个正则很容易写：\[em\]e(\d+)\[/em\]，然后可以用 re.sub 的 repl 参数实现查询调用： def&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://zzsblog.top/async-re-sub.html"><link rel="amphtml" href="https://zzsblog.top/amp/async-re-sub.html"><link rel="alternate" type="application/atom+xml" href="https://zzsblog.top/feed.xml"><link rel="alternate" type="application/json" href="https://zzsblog.top/feed.json"><meta property="og:title" content="re.sub如何异步替换？"><meta property="og:image" content="https://zzsblog.top/media/posts/1/download1-2"><meta property="og:site_name" content="鸽园"><meta property="og:description" content="这是解析Qzone3TG系列的第二篇。代码见 aioqzone-feed/api/emoji.py 现在有这样一个需求： 这是一段[em]e100[/em]富文本[em]e101[/em]，是emotion_cgi_msgdetail_v6的返回[em]102[/em] 把上面这段文本里的表情码换成正常人能看的文字或 emoji。大家一眼就能看出来，得用正则表达式。 这个正则很容易写：\[em\]e(\d+)\[/em\]，然后可以用 re.sub 的 repl 参数实现查询调用： def&hellip;"><meta property="og:url" content="https://zzsblog.top/async-re-sub.html"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://zzsblog.top/media/website/favicon.png" type="image/png"><link rel="stylesheet" href="https://zzsblog.top/assets/css/style.css?v=ebde456a0982dc3b4cf9161f1fc0c160"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://zzsblog.top/async-re-sub.html"},"headline":"re.sub如何异步替换？","datePublished":"2022-07-31T16:06","dateModified":"2022-07-31T20:51","image":{"@type":"ImageObject","url":"https://zzsblog.top/media/posts/1/download1-2","height":false,"width":false},"description":"这是解析Qzone3TG系列的第二篇。代码见 aioqzone-feed/api/emoji.py 现在有这样一个需求： 这是一段[em]e100[/em]富文本[em]e101[/em]，是emotion_cgi_msgdetail_v6的返回[em]102[/em] 把上面这段文本里的表情码换成正常人能看的文字或 emoji。大家一眼就能看出来，得用正则表达式。 这个正则很容易写：\\[em\\]e(\\d+)\\[/em\\]，然后可以用 re.sub 的 repl 参数实现查询调用： def&hellip;","author":{"@type":"Person","name":"JamzumSum","url":"https://zzsblog.top/author/jamzumsum/"},"publisher":{"@type":"Organization","name":"JamzumSum","logo":{"@type":"ImageObject","url":"https://zzsblog.top/media/website/favicon-2.png","height":480,"width":480}}}</script><script>window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      processEscapes: true,
    }
  }</script><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><link href="https://cdn.jsdelivr.net/npm/prismjs@v1.x/themes/prism.css" rel="stylesheet"></head><body><script src="https://cdn.jsdelivr.net/npm/prismjs@v1.x/components/prism-core.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@v1.x/plugins/autoloader/prism-autoloader.min.js"></script><div class="container"><header class="header" id="js-header"><a href="https://zzsblog.top/" class="logo"><img src="https://zzsblog.top/media/website/favicon-2.png" alt="鸽园" width="480" height="480"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://zzsblog.top/" title="Goto Homepage" target="_self">Home</a></li><li class="has-submenu"><a href="https://zzsblog.top/tag/" title="Categories" target="_blank" aria-haspopup="true">Categories</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://zzsblog.top/tag/coding/" title="Coding" target="_blank">Coding</a></li><li><a href="https://zzsblog.top/tag/qzone2tg/" title="Collections of Qzone2TG posts" target="_self">Qzone2TG</a></li></ul></li><li><a href="https://zzsblog.top/about.html" title="About me" target="_self">About</a></li><li><span class="is-separator">|</span></li><li><a href="https://github.com/JamzumSum/zzsblog" title="Goto blog repo on GitHub" target="_blank">GitHub</a></li><li><a href="https://zzsblog.top/merger.html" title="Buy me a cup of coffee☕" target="_blank">Donate</a></li></ul></nav></header><main><article class="post wrapper"><header class="hero"><p class="post__meta">Published on <time datetime="2022-07-31T16:06">22/07/31</time></p><h1 class="post__title">re.sub如何异步替换？</h1></header><figure class="post__featured-image post__image--wide"><img src="https://zzsblog.top/media/posts/1/download1-2" loading="eager" height="1280" width="1920" alt="two white flying rockets during daytime"><figcaption>two white flying rockets during daytime @spacex</figcaption></figure><div class="post__entry"><blockquote><p>这是<code>解析Qzone3TG</code>系列的第二篇。代码见 <a href="https://github.com/JamzumSum/aioqzone-feed/blob/207b9724d6e89ac17fbcca0406c00bb297c4f6d2/src/aioqzone_feed/api/emoji.py#L31-L59" title="aioqzone-feed/api/emoji.py::sub">aioqzone-feed/api/emoji.py</a></p></blockquote><h2 id="motivation">Motivation</h2><p>现在有这样一个需求：</p><pre><code>这是一段[em]e100[/em]富文本[em]e101[/em]，是emotion_cgi_msgdetail_v6的返回[em]102[/em]
</code></pre><p>把上面这段文本里的表情码换成正常人能看的文字或 emoji。大家一眼就能看出来，得用正则表达式。 这个正则很容易写：<code>\[em\]e(\d+)\[/em\]</code>，然后可以用 <code>re.sub</code> 的 <code>repl</code> 参数实现查询调用：</p><pre><code class="language-python">def sync_query(eid: int) -&gt; str | None: ...

re.sub(r&quot;\[em\]e(\d+)\[/em\]&quot;, lambda m: sync_query(int(m.group(1))) or m.group(0), text)
</code></pre><p>不过事情往往不会如人们想象的那样发展。比如：我们这个 <a href="https://github.com/JamzumSum/QzEmoji/blob/7c85c5d2fcb01631775fc7f2162ad12d98e485b1/src/qzemoji/__init__.py#L59-L61">查询函数</a> 压根不是个同步函数。</p><p>事实上，由于 <code>QzEmoji</code> <code>async</code> 分支使用的是 <code>sqlalchemy</code>+<code>aiosqlite</code>，异步查询是我们的本意。 所以，如何让 <code>re.sub</code> 支持一个异步的替换函数呢？</p><h2 id="solution">Solution</h2><p>实际上，我们没办法让 <code>re.sub</code> 支持一个异步的 <code>async</code>。不过，我们可以自己写一个 <code>sub</code>。</p><pre><code class="language-python">r, tasks = [], []
base = 0
for i, m in enumerate(pattern.finditer(text)):
    fr, to = m.span(0)
    r.append(text[base:fr])  # save un-replaced string as is
    task = asyncio.create_task(repl(m))
    task.add_done_callback(lambda t, idx=i: r.__setitem__(idx, r[idx] + t.result()))
    tasks.append(task)
    base = to
r.append(text[base:])
</code></pre><p>我们用 <code>re.finditer</code> 找出所有表情码的位置。对于每一个表情码 $e_i = text[from_i, to_i]$ 来说，它的 $from_i$ 到上一个表情码的 $to_{i-1}$ 之间这段串 $p_i = text[to_{i-1}, from_i]$ 是不需要修改的， 直接保存就可以，我们记做 $p_i$；每一个表情码对应一个异步查询任务，它的完成回调是给 $p_i$ 串追加查询结果，即 $p_i += query(e_i)$。最后不要忘了，最后一个表情码之后也可能有不需要改变的文字 $p_{n+1} = text[to_n:]$。</p><p>记得生成的任务都要存起来，然后我们 <code>asyncio.wait(tasks)</code> 等待所有任务都结束。在这之后，把 $p_0, … p_{n+1}$ 拼起来就可以了：</p><pre><code class="language-python">if tasks: await asyncio.wait(tasks)
return &quot;&quot;.join(r)
</code></pre><h2 id="后记">后记</h2><p>关于性能，我并没有做过验证。不过从经验推测，文本中只有一两个表情码的话，我想异步 <code>sub</code> 的速度赶不上 <code>re.sub</code>。不过如果有比较多的表情码的话，异步优势还是能显现的。</p></div><footer class="post__footer"><div class="post__footer__col"><ul class="post__tag"><li><a href="https://zzsblog.top/tag/coding/">Coding</a></li><li><a href="https://zzsblog.top/tag/python/">Python</a></li><li><a href="https://zzsblog.top/tag/qzone2tg/">Qzone2TG</a></li></ul><div class="post__share"></div></div><nav class="post__nav"><div class="post__nav__prev">Previous Post<h5><a href="https://zzsblog.top/ssh-reverse-proxy.html" class="inverse" rel="prev">不能连外网的机器怎么搭环境？</a></h5></div><div class="post__nav__next">Next Post<h5><a href="https://zzsblog.top/edit-exif-header.html" class="inverse" rel="next">如何修改图像的 EXIF 头信息？</a></h5></div></nav></footer></article></main><footer class="footer"><div class="footer__copyright">Powered by Publii</div></footer></div><script defer="defer" src="https://zzsblog.top/assets/js/scripts.min.js?v=620157e86bfc246cfef480b1b4aadb48"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.navbar'};</script><script>/*<![CDATA[*/var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};/*]]>*/</script></body></html>