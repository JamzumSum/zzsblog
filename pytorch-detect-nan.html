<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Locate NaN in PyTorch</title><meta name="description" content="How to detect and locate NaN in PyTorch"><meta name="generator" content="Publii Open-Source CMS for Static Site"><meta name="theme-color" content="#17181E" media="(prefers-color-scheme: dark)"><meta name="theme-color" content="#7A918B" media="(prefers-color-scheme: light)"><meta name="msapplication-navbutton-color" content="#7A918B"><meta name="apple-mobile-web-app-status-bar-style" content="#7A918B"><link rel="canonical" href="https://zzsblog.top/pytorch-detect-nan.html"><link rel="amphtml" href="https://zzsblog.top/amp/pytorch-detect-nan.html"><link rel="alternate" type="application/atom+xml" href="https://zzsblog.top/feed.xml"><link rel="alternate" type="application/json" href="https://zzsblog.top/feed.json"><meta property="og:title" content="Pytorch 如何定位 NaN？"><meta property="og:image" content="https://zzsblog.top/media/posts/6/download1-3"><meta property="og:site_name" content="鸽园"><meta property="og:description" content="How to detect and locate NaN in PyTorch"><meta property="og:url" content="https://zzsblog.top/pytorch-detect-nan.html"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://zzsblog.top/media/website/favicon.png" type="image/png"><link rel="stylesheet" href="https://zzsblog.top/assets/css/style.css?v=83410d9231f8f5a3cb33c06820933ffc"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://zzsblog.top/pytorch-detect-nan.html"},"headline":"Pytorch 如何定位 NaN？","datePublished":"2021-08-07T20:33","dateModified":"2022-08-01T20:23","image":{"@type":"ImageObject","url":"https://zzsblog.top/media/posts/6/download1-3","height":false,"width":false},"description":"How to detect and locate NaN in PyTorch","author":{"@type":"Person","name":"JamzumSum","url":"https://zzsblog.top/author/jamzumsum/"},"publisher":{"@type":"Organization","name":"JamzumSum","logo":{"@type":"ImageObject","url":"https://zzsblog.top/media/website/favicon-2.png","height":480,"width":480}}}</script><script>window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      processEscapes: true,
    }
  }</script><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><link href="https://cdn.jsdelivr.net/npm/prismjs@v1.x/themes/prism.css" rel="stylesheet"></head><body><script src="https://cdn.jsdelivr.net/npm/prismjs@v1.x/components/prism-core.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@v1.x/plugins/autoloader/prism-autoloader.min.js"></script><div class="container"><header class="header" id="js-header"><a href="https://zzsblog.top/" class="logo"><img src="https://zzsblog.top/media/website/favicon-2.png" alt="鸽园" width="480" height="480"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://zzsblog.top/" title="Goto Homepage" target="_self">Home</a></li><li class="has-submenu"><a href="https://zzsblog.top/tag/" title="Categories" target="_self" aria-haspopup="true">Categories</a><ul class="navbar__submenu level-2" aria-hidden="true"><li class="has-submenu"><a href="https://zzsblog.top/tag/coding/" title="Coding" target="_self" aria-haspopup="true">Coding</a><ul class="navbar__submenu level-3" aria-hidden="true"><li class="has-submenu"><a href="https://zzsblog.top/tag/python/" title="Python" target="_self" aria-haspopup="true">Python</a><ul class="navbar__submenu level-4" aria-hidden="true"><li><a href="https://zzsblog.top/tag/pytorch/" title="torch" target="_self">PyTorch</a></li></ul></li></ul></li><li><a href="https://zzsblog.top/tag/qzone2tg/" title="Collections of Qzone2TG posts" target="_self">Qzone2TG</a></li></ul></li><li><a href="https://zzsblog.top/about.html" title="About me">About</a></li><li><a href="https://github.com/JamzumSum/zzsblog" title="Goto blog repo on GitHub" target="_blank">GitHub</a></li><li><a href="https://zzsblog.top/merger.html" title="Buy me a cup of coffee☕" target="_self">Donate</a></li></ul></nav><div class="search"><div class="search__overlay js-search-overlay"></div><button class="search__btn js-search-btn" aria-label="Search"><svg role="presentation" focusable="false" height="15" width="15"><use xlink:href="https://zzsblog.top/assets/svg/svg-map.svg#search"/></svg></button></div></header><main><article class="post wrapper"><header class="hero"><p class="post__meta">Published on <time datetime="2021-08-07T20:33">21/08/07</time></p><h1 class="post__title">Pytorch 如何定位 NaN？</h1></header><figure class="post__featured-image post__image--wide"><img src="https://zzsblog.top/media/posts/6/download1-3" loading="eager" height="1440" width="1920" alt="orange and black bug on green leaf"><figcaption>A bug @ringane</figcaption></figure><div class="post__entry"><blockquote><p>有关内容在网上其实有一些比较系统的文章, 但灌水很多相对不太好找. 这里结合我自己的经验再总结一下.</p></blockquote><blockquote><p>注：本文讨论的是<strong>单精度训练</strong>。半精度训练会有更多的NaN成因，但不在本文讨论之列。</p></blockquote><h2 id="三板斧">三板斧</h2><p>检查NaN有三板斧, 尽管调试NaN通常需要一定的经验和耐心, 但记住这三个至少不至于手足无措.</p><h3 id="1-正向传播异常侦测">#1 正向传播异常侦测</h3><pre><code class="language-python">torch.autograd.set_detect_anomaly(True)
</code></pre><p>如题, forward时出现NaN即时报错. 尽管说得好听, 但有的时候并不能准确地定位问题所在. 属于调试NaN的必要辅助.</p><h3 id="2-反向传播异常侦测">#2 反向传播异常侦测</h3><pre><code class="language-python"># loss = model(X)
with torch.autograd.detect_anomaly():
    loss.backward()
</code></pre><p>如题, backward时出现NaN时即时报错. 相比#1来说更难确切定位问题, 往往用于兜底, 即确保出现NaN时程序会尽快抛出异常.</p><h3 id="3-assert">#3 assert</h3><p>我们已经知道，NaN是一种具有传染性的错误。<strong>NaN debugging的关键问题是定位第一个NaN出现的位置。</strong></p><p>在pytorch中, 检查NaN的函数为<code>torch.isnan(T)</code>. 于是我们可以构造如下断言:</p><pre><code class="language-python">assert not torch.any(torch.isnan(T))
</code></pre><blockquote><p>当然, 这么写其实有一点性能浪费, 但写python, 又是debug专用代码, 何必考虑这么多呢¯\_(ツ)_/¯</p></blockquote><p>这是一个需要判断力的方法：将这个断言加在你认为有可能出现NaN的步骤之后. 你的判断可以帮助你少加断言、快速找到第一现场。 不过没找到第一现场也不用担心，尽管这个现场已经漂移, 你也可以利用调试器的堆栈功能快速搜寻真正的事发现场.</p><h2 id="nan的可能原因">NaN的可能原因</h2><p>讲完三板斧总得讲讲NaN的成因, 要不然就是光有方法没有理论(x 尤其是#3, 要求调试者非常充分且熟练地掌握NaN的可能成因.</p><h3 id="梯度爆炸">梯度爆炸</h3><p>梯度爆炸, 或者梯度消失都可能导致NaN. 这个问题往往会被#2 反向传播异常检测捕获, 但真正定位到问题却难上加难. 相对来说, 重新推导一遍自己的理论模型、寻找可能导致梯度爆炸的计算显得更有针对性.</p><h3 id="计算不合法">计算不合法</h3><p>这也是NaN最常见的成因. 毕竟大多数的网络, 尤其是复现、组合别人的网络结构一般不会碰到梯度爆炸的问题, 而NaN大多出现于loss计算的部分, 诞生于某个小小的不合法计算, 然后污染它参与计算的所有结果, 最后在你的loss值上表现出来.</p><p>常见套路:</p><ul><li>$ log(x), x \leq 0 $</li><li>$ c/0 $</li></ul><blockquote><p>尚有其他的一些情况我自己没遇到过, 网上可能会有补充</p></blockquote><p>这种问题运气好的话会被#1 正向异常检测直接找到, 但通常是找到一个漂移了亿点点的位置. 推荐用#3 assert的办法, 尤其是 <strong>自己写了loss时</strong>, 在关键位置放几个assert守门, 总归是没错的.</p><p>注意, 绝大多数时候, inf也是不合常理的存在. 因此你可能也需要同时寻找inf:</p><pre><code class="language-python">assert not torch.any(torch.isnan(T) + torch.isinf(T))
</code></pre><h3 id="脏数据">脏数据</h3><p>NaN的次常见成因. 顾名思义, 出现NaN仅仅是因为数据里含有NaN. 通常来说直接读图片不会出现NaN, 往往是大意地处理数据后会出现这种情况.</p><p>随便举个例子.</p><pre><code class="language-python">mask = mask / mask.max()
# serialize mask
</code></pre><p>这句话看起来没问题, 把uint8{0, 255}转成float32[0, 1]. 相信很多人都这么写过. 正常来说不会有任何问题, 直到我遇到了一张纯黑的mask :P</p><p>毕竟谁也不会想到有一张图没标注还给放数据集里了是吧. 但不管怎么说, 此时我们犯了”除零”的错误. 这个mask会变成携带NaN的脏数据输入模型, 并在计算loss时将loss结果污染. 如果程序没有及时终止, 在仅仅一次反向传播之后, 你的模型参数将变为NaN, 其一切推导将得出NaN ¯\_(ツ)_/¯</p><h2 id="检查nan的一般步骤">检查NaN的一般步骤</h2><ol><li>检查数据</li><li>开启正向和反向异常检测</li><li>给模型的直接输出结果和最终loss加assert</li><li>通过经验、猜测、反推等方法逐步把assert加到之前的步骤, 直到触发的assert帮你找到了不合法计算</li><li>若计算loss的过程中没有发现问题, 且总是触发反向传播异常, 那可以考虑从理论上检查梯度爆炸和梯度消失</li></ol></div><footer class="post__footer"><div class="post__footer__col"><ul class="post__tag"><li><a href="https://zzsblog.top/tag/coding/">Coding</a></li><li><a href="https://zzsblog.top/tag/python/">Python</a></li><li><a href="https://zzsblog.top/tag/pytorch/">PyTorch</a></li></ul><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fzzsblog.top%2Fpytorch-detect-nan.html" class="js-share facebook" aria-label="Share with Facebook" rel="nofollow noopener noreferrer"><svg class="icon"><use xlink:href="https://zzsblog.top/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fzzsblog.top%2Fpytorch-detect-nan.html&amp;media=https%3A%2F%2Fzzsblog.top%2Fmedia%2Fposts%2F6%2Fdownload1-3&amp;description=Pytorch%20%E5%A6%82%E4%BD%95%E5%AE%9A%E4%BD%8D%20NaN%EF%BC%9F" class="js-share pinterest" aria-label="[MISSING TRANSLATION] Share with Pinterest" rel="nofollow noopener noreferrer"><svg class="icon"><use xlink:href="https://zzsblog.top/assets/svg/svg-map.svg#pinterest"/></svg> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzzsblog.top%2Fpytorch-detect-nan.html" class="js-share linkedin" aria-label="Share with LinkedIn" rel="nofollow noopener noreferrer"><svg class="icon"><use xlink:href="https://zzsblog.top/assets/svg/svg-map.svg#linkedin"/></svg></a></div></div></footer></article><div class="comments-area wrapper"></div><div class="banner banner--after-post"><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"></a><br>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</div></main><footer class="footer"><div class="footer__copyright">Powered by Publii, Copyright (c) 2022 JamzumSum</div></footer></div><script defer="defer" src="https://zzsblog.top/assets/js/scripts.min.js?v=620157e86bfc246cfef480b1b4aadb48"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.navbar'};</script><script>/*<![CDATA[*/var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};/*]]>*/</script></body></html>