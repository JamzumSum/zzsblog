<!DOCTYPE html>
<html  lang="zh_CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta content="PyTorch" name="keywords" />

      <title>Pytorch定位NaN</title>
    
          <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../_static/theme.css " type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
        <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../_static/theme-vendors.js"></script> -->
      <script src="../_static/theme.js" defer></script>
      <link rel="canonical" href="www.zzsblog.top/Coding/pytorch定位NaN.html" />
    
      <link rel="shortcut icon" href="../_static/favicon.png"/>
  <link rel="author" title="关于这些文档" href="../about.html" />
  <link rel="index" title="索引" href="../genindex.html" />
  <link rel="search" title="搜索" href="../search.html" />
  <link rel="next" title="Products" href="../Products/index.html" />
  <link rel="prev" title="Python 解析不规则 JSON" href="python%E8%A7%A3%E6%9E%90%E4%B8%8D%E8%A7%84%E5%88%99json.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../index.html" class="home-link">
    
      <img class="logo" src="../_static/favicon.png" alt="logo"/>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



  
    <div class="nav-item">
      <a href="index.html"
        class="nav-link external">
          首页 <outboundlink></outboundlink>
      </a>
    </div>
  
    <div class="nav-item">
      <a href="about.html"
        class="nav-link external">
          关于 <outboundlink></outboundlink>
      </a>
    </div>
  
    <div class="nav-item">
      <a href="donate.html"
        class="nav-link external">
          捐赠 <outboundlink></outboundlink>
      </a>
    </div>
  
    <div class="nav-item">
      <a href="https://github.com/JamzumSum/zzsblog.github.io"
        class="nav-link external">
          GitHub <outboundlink></outboundlink>
      </a>
    </div>
  

    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



  
    <div class="nav-item">
      <a href="index.html"
        class="nav-link external">
          首页 <outboundlink></outboundlink>
      </a>
    </div>
  
    <div class="nav-item">
      <a href="about.html"
        class="nav-link external">
          关于 <outboundlink></outboundlink>
      </a>
    </div>
  
    <div class="nav-item">
      <a href="donate.html"
        class="nav-link external">
          捐赠 <outboundlink></outboundlink>
      </a>
    </div>
  
    <div class="nav-item">
      <a href="https://github.com/JamzumSum/zzsblog.github.io"
        class="nav-link external">
          GitHub <outboundlink></outboundlink>
      </a>
    </div>
  

            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">快速搜索</span>
    <div class="searchformwrapper">
      <form class="search" action="../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="搜索" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
    
    <div class="sidebar-group">
        <p class="caption">
            <span class="caption-text"><a href="../index.html#id1">分类</a></span>
        </p>
        <ul class="">
            
            <li class="toctree-l1 ">
                
                <a href="index.html"
                    class="reference internal ">   Coding</a>
                

                
            </li>

            
            <li class="toctree-l1 ">
                
                <a href="../Products/index.html"
                    class="reference internal ">   Products</a>
                

                
            </li>

            
            <li class="toctree-l1 ">
                
                <a href="../Research/index.html"
                    class="reference internal ">   Research</a>
                

                
            </li>

            
        </ul>
    </div>
    
    
        <hr>
        <div class="sidebar-group">
            
            
            

            <p class="caption">
<span class="caption-text"><a class="reference internal" href="#">Pytorch定位NaN</a><ul class="toctree-l1">
<li><a class="reference internal" href="#id1">三板斧</a><ul class="toctree-l1">
<li><a class="reference internal" href="#id2">#1 正向传播异常侦测</a></span>
<li><a class="reference internal" href="#id3">#2 反向传播异常侦测</a></span>
<li><a class="reference internal" href="#assert">#3 assert</a></span>
</ul>
</span>
<li><a class="reference internal" href="#nan">NaN的可能原因</a><ul class="toctree-l1">
<li><a class="reference internal" href="#id4">梯度爆炸</a></span>
<li><a class="reference internal" href="#id5">计算不合法</a></span>
<li><a class="reference internal" href="#id6">脏数据</a></span>
</ul>
</span>
<li><a class="reference internal" href="#id7">检查NaN的一般步骤</a></span>
</ul>
</span>
</p>

        </div>
    
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      <li><a href="index.html">Coding</a> &raquo;</li>
    
    <li>Pytorch定位NaN</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="python%E8%A7%A3%E6%9E%90%E4%B8%8D%E8%A7%84%E5%88%99json.html"
       title="上一章">← Python 解析不规则 JSON</a>
  </li>
  <li class="next">
    <a href="../Products/index.html"
       title="下一章">Products →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <section class="tex2jax_ignore mathjax_ignore" id="pytorchnan">
<h1>Pytorch定位NaN<a class="headerlink" href="#pytorchnan" title="永久链接至标题">¶</a></h1>
<blockquote>
<div><p>有关内容在网上其实有一些比较系统的文章, 但水文更多一点相对不太好找. 这里结合我自己的经验再总结一下.</p>
</div></blockquote>
<section id="id1">
<h2>三板斧<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>检查NaN有三板斧, 尽管调试NaN通常需要一定的经验和耐心, 但记住这三个至少不至于手足无措.</p>
<section id="id2">
<h3>#1 正向传播异常侦测<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_detect_anomaly</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>如题, forward时出现NaN即时报错. 尽管说得好听, 但有的时候并不能准确地定位问题所在. 属于调试NaN的必要辅助.</p>
</section>
<section id="id3">
<h3>#2 反向传播异常侦测<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># loss = model(X)</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">detect_anomaly</span><span class="p">():</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>
</div>
<p>如题, backward时出现NaN时即时报错. 相比#1来说更难确切定位问题, 往往用于兜底, 即确保出现NaN时程序会尽快抛出异常.</p>
</section>
<section id="assert">
<h3>#3 assert<a class="headerlink" href="#assert" title="永久链接至标题">¶</a></h3>
<p>assert是确保程序行为正确的重要手段. 对于一个算法来说, 出现NaN不管怎么说都意味着不正常. 同时, 对debug来说, 最重要的就是找到事发现场, 而assert正是寻找真正现场的利器.</p>
<p>在pytorch中, 检查NaN的函数为<code class="docutils literal notranslate"><span class="pre">torch.isnan(T)</span></code>. 于是我们可以构造如下断言:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
</pre></div>
</div>
<blockquote>
<div><p>当然, 这么写其实有一点性能浪费, 但写python, 又是debug专用代码, 何必考虑这么多呢¯\_(ツ)_/¯</p>
</div></blockquote>
<p>将这个断言加在你认为有可能出现NaN的步骤之后. 这样一旦出现NaN, 你至少能抓住一个现场. 哪怕这个现场已经漂移, 配合调试器你也能更有逻辑地找到真正的事发现场.</p>
</section>
</section>
<section id="nan">
<h2>NaN的可能原因<a class="headerlink" href="#nan" title="永久链接至标题">¶</a></h2>
<p>讲完三板斧总得讲讲NaN的成因, 要不然就是光有方法没有理论(x 尤其是#3, 要求调试者非常充分且熟练地掌握NaN的可能成因.</p>
<section id="id4">
<h3>梯度爆炸<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>梯度爆炸, 或者梯度消失都可能导致NaN. 这个问题往往会被#2 反向传播异常检测捕获, 但真正定位到问题却难上加难. 相对来说, 重新推导一遍自己的理论模型、寻找可能导致梯度爆炸的计算显得更有针对性.</p>
</section>
<section id="id5">
<h3>计算不合法<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>这也是NaN最常见的成因. 毕竟大多数的网络, 尤其是复现、组合别人的网络结构一般不会碰到梯度爆炸的问题, 而NaN大多出现于loss计算的部分, 诞生于某个小小的不合法计算, 然后污染它参与计算的所有结果, 最后在你的loss值上表现出来.</p>
<p>常见套路:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\( log(x), x \leq 0 \)</span></p></li>
<li><p><span class="math notranslate nohighlight">\( c/0 \)</span></p></li>
</ul>
<blockquote>
<div><p>尚有其他的一些情况我自己没遇到过, 网上可能会有补充</p>
</div></blockquote>
<p>这种问题运气好的话会被#1 正向异常检测直接找到, 但通常是找到一个漂移了亿点点的位置. 推荐用#3 assert的办法, 尤其是 <strong>自己写了loss时</strong>, 在关键位置放几个assert守门, 总归是没错的.</p>
<p>注意, 绝大多数时候, inf也是不合常理的存在. 因此你可能也需要同时寻找inf:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3>脏数据<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>NaN的次常见成因. 顾名思义, 出现NaN仅仅是因为数据里含有NaN. 通常来说直接读图片不会出现NaN, 往往是大意地处理数据后会出现这种情况.</p>
<p>随便举个例子.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">/</span> <span class="n">mask</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="c1"># serialize mask</span>
</pre></div>
</div>
<p>这句话看起来没问题, 把uint8{0, 255}转成float32[0, 1]. 相信很多人都这么写过. 正常来说不会有任何问题, 直到我遇到了一张纯黑的mask :P</p>
<p>毕竟谁也不会想到有一张图没标注还给放数据集里了是吧. 但不管怎么说, 此时我们犯了”除零”的错误. 这个mask会变成携带NaN的脏数据输入模型, 并在计算loss时将loss结果污染. 如果程序没有及时终止, 在仅仅一次反向传播之后, 你的模型参数将变为NaN, 其一切推导将得出NaN ¯\_(ツ)_/¯</p>
</section>
</section>
<section id="id7">
<h2>检查NaN的一般步骤<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<ol class="arabic simple">
<li><p>检查数据</p></li>
<li><p>开启正向和反向异常检测</p></li>
<li><p>给模型的直接输出结果和最终loss加assert</p></li>
<li><p>通过经验、猜测、反推等方法逐步把assert加到之前的步骤, 直到触发的assert帮你找到了不合法计算</p></li>
<li><p>若计算loss的过程中没有发现问题, 且总是触发反向传播异常, 那可以考虑从理论上检查梯度爆炸和梯度消失</p></li>
</ol>
<blockquote>
<div><p>未完待续: 可能会加入新的例子和参考</p>
</div></blockquote>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="python%E8%A7%A3%E6%9E%90%E4%B8%8D%E8%A7%84%E5%88%99json.html"
       title="上一章">← Python 解析不规则 JSON</a>
  </li>
  <li class="next">
    <a href="../Products/index.html"
       title="下一章">Products →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; 版权所有 2021-2022, JamzumSum.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>